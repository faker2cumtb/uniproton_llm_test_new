# 日志介绍
## 什么是日志
日志是记录系统运行过程中的用户操作，系统运行状态等信息的文件，在系统运行过程中创建。

## 为什么需要日志
日志记录系统的运行过程及异常信息，为快速定位系统运行中出现的问题及开发过程中的程序调试问题提供详细信息。还可以用来监视系统中发生的事件，预警系统的潜在风险，发现系统瓶颈等。

## 概念解释
| 名称 | 解释说明 |
| ---- | ---- |
| facility | 日志来源/类型，同linux syslog facility，范围[0,23], 其中16到23为用户自定义的日志类型 |
| level | 日志级别，同linux syslog facility，范围[0,7] |
| 环形缓冲区 | 长度固定的先进先出队列，使用一段固定长度的内存，通过一头一尾两个指针控制数据的读取和写入，指针到达内存尾部后，继续移动会回到内存起始位置，读指针不能超过写指针（队列长度不能小于0），写指针也不能超过读指针一整圈（不能超过队列固定长度）|
| 实时侧 | 实时系统侧，此处特指UniProton系统 |
| 非实时侧 | 非实时系统侧，负责拉起实时系统，通常为linux系统 |

## 日志机制
UniProton的日志使用环形缓冲区实现，环形缓冲区建立在一块长度固定的共享内存上，该共享内存可以被实时侧和非实时侧同时访问。实时侧负责生产日志，将日志数据写入环形缓冲区，并控制写指针移动，非实时侧的配套内核模块则负责读取环形缓冲区的日志，并控制读指针移动。后续非实时侧系统负责对日志进行统一的管理，保存为日志文件或输出至终端。日志输出过程中的耗时操作尽量由非实时侧负责，保证UniProton日志输出接口的开销尽量小。

## 日志非实时侧配套指南
### 预留内存
在使用日志模块前，需要先将日志模块需要的共享内存预留出来，现阶段日志模块需要17MB共享内存。以hi3093为例子，参考`demos/hi3093/bsp/mmu.c`，日志使用的内存物理地址为`0x94000000`，长度为`0x1100000`。可以通过修改非实时侧dtb的方式预留内存，如下为dtb预留的一个例子，需要预留一块名为 “oe,log_mem” 的内存区域（不能使用其他名字），起始地址为`0x94000000`，长度为`0x1100000`。

    reserved-memory {
    
        ......
    
        client_os_log_mem: client_os_log_mem@94000000 {
            reg = <0x0 0x94000000 0x00 0x1100000>;
            no-map;
        };
    
        ......
    
    };
    
    ......
    
    UniProton-log-mem {
        compatible = "oe,log_mem";
        memory-region = <&client_os_log_mem>;
    };

### 内核模块安装，启动
将`src/host/log`内的文件，编译成非实时侧系统的内核模块，并使用`insmod`命令行安装模块。

该内存模块会在安装后在dtb中查找 “oe,log_mem” 节点，如果节点有分配内存区域，并且长度足够，就会使用该内存区域的物理地址作为环形缓冲区的基地址，初始化环形缓冲区，并拉起日志读取背景线程，开始从环形缓冲区读取日志。

如果使用其他方式预留内存，模块安装后不会拉起日志读取背景线程。模块安装后会注册名为 `/dev/logW` 的设备，可以通过`ioctl`接口将预留物理内存传递给该设备，内核态模块接收到地址后，会使用该地址作为环形缓冲区的基地址，初始化环形缓冲区，并拉起日志读取背景线程。用户可以自行编译非实时侧用户态程序来传递预留内存的物理地址，可参考如下C代码：

    #include <fcntl.h>
    #include <sys/ioctl.h>

    #define IOC_LOG_START   _IOW('L', 0, uint64_t)

    uint64_t phyAddr = XXX;
    int fd = open("/dev/logW", O_RDWR | O_SYNC);
    int ret = ioctl(fd, IOC_LOG_START, &phyAddr);

背景线程读取到日志后，会使用`printk`接口将UniProton日志作为非实时侧的内核日志输出，可以在`/dev/kmsg`中获取日志，或使用`dmesg`命令行获取日志。如果非实时侧系统支持rsyslog，可以通过配置`/etc/rsyslog.conf`将UniProton日志保存为指定文件，或输出到指定终端。可参考如下配置，将UniProton日志保存到`/var/log/UniLog`文件中。

    # Save UniProton
    local0.*;local1.*;local2.*;local3.*;local4.*;local5.*;local6.*;local7.*  /var/log/UniLog

## 注意事项
拉起日志读取背景线程必须在拉起UniProton之前。
